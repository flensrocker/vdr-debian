#! /bin/sh /usr/share/dpatch/dpatch-run
##
## DP: This allows to add a RECSTART macro to a timer, which will be replaced
## DP: when recording starts with the current time (not the timer start time!).
## DP:
## DP: This way after each interrupted recording a new *.rec will be created
## DP: This is required by the ARD MAM-system to be able to cut time-based slices
## DP: from a loop recording.

@DPATCH@
Index: vdr/recording.c
===================================================================
--- vdr.orig/recording.c	2012-03-13 23:18:56.000000000 +0100
+++ vdr/recording.c	2012-03-13 23:19:11.000000000 +0100
@@ -635,10 +635,16 @@
      }
   const char *macroTITLE   = strstr(Timer->File(), TIMERMACRO_TITLE);
   const char *macroEPISODE = strstr(Timer->File(), TIMERMACRO_EPISODE);
-  if (macroTITLE || macroEPISODE) {
+  const char *macroRECSTART = strstr(Timer->File(), TIMERMACRO_RECSTART);
+  if (macroTITLE || macroEPISODE || macroRECSTART) {
      name = strdup(Timer->File());
      name = strreplace(name, TIMERMACRO_TITLE, Title);
-     name = strreplace(name, TIMERMACRO_EPISODE, Subtitle);
+     struct tm tm_r;
+     time_t now = time(NULL);
+     localtime_r(&now, &tm_r);
+     char buffer[15];
+     strftime(buffer, sizeof(buffer), "%Y%m%d%H%M%S", &tm_r);
+     name = strreplace(name, TIMERMACRO_RECSTART, buffer);
      // avoid blanks at the end:
      int l = strlen(name);
      while (l-- > 2) {
Index: vdr/recording.h
===================================================================
--- vdr.orig/recording.h	2012-03-13 23:18:56.000000000 +0100
+++ vdr/recording.h	2012-03-13 23:19:11.000000000 +0100
@@ -21,6 +21,7 @@
 #define FOLDERDELIMCHAR '~'
 #define TIMERMACRO_TITLE    "TITLE"
 #define TIMERMACRO_EPISODE  "EPISODE"
+#define TIMERMACRO_RECSTART  "RECSTART"
 
 #define __RECORDING_H_DEPRECATED_DIRECT_MEMBER_ACCESS // Code enclosed with this macro is deprecated and may be removed in a future version
 
